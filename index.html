<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助手</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/lib/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --bg-color: #f8fafc;
            --surface-color: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --message-user-bg: #e0f2fe;
            --message-bot-bg: #ffffff;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 1rem;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .header-buttons button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            background-color: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .header-buttons button:hover {
            background-color: var(--bg-color);
            transform: none;
            box-shadow: none;
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .message {
            max-width: 85%;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 0.5rem;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: var(--message-user-bg);
            margin-left: auto;
        }

        .bot-message {
            background-color: var(--message-bot-bg);
            margin-right: auto;
            border: 1px solid var(--border-color);
        }

        .message-content {
            line-height: 1.6;
            font-size: 0.9375rem;
        }

        .message-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .message-content code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
        }

        .message-content p {
            margin: 0.5rem 0;
        }

        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .copy-button {
            opacity: 1;
        }

        #suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .suggestion-chip {
            padding: 0.5rem 1rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background-color: var(--message-user-bg);
            color: var(--primary-color);
        }

        #input-container {
            display: flex;
            gap: 0.5rem;
            padding: 1rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
        }

        #user-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 0.9375rem;
            resize: none;
            min-height: 2.5rem;
            max-height: 150px;
            background-color: var(--surface-color);
        }

        #user-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        #send-button {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #send-button:hover {
            background-color: var(--primary-dark);
        }

        #stop-button {
            display: none;
            padding: 0.75rem 1.5rem;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.9375rem;
            cursor: pointer;
        }

        #stop-button:hover {
            background-color: #dc2626;
        }

        .error-message {
            padding: 0.75rem;
            background-color: #fef2f2;
            color: #dc2626;
            border-radius: 0.375rem;
            margin: 0.5rem 0;
            font-size: 0.875rem;
            display: none;
        }

        @media (max-width: 640px) {
            .container {
                padding: 0.5rem;
            }

            .message {
                max-width: 95%;
            }

            .header {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
                text-align: center;
            }

            .header-buttons {
                justify-content: center;
            }
        }

        /* 智能操作菜单 */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }

        .context-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
            transition: background-color 0.2s;
        }

        .context-menu-item:hover {
            background-color: var(--bg-color);
        }

        /* 角色选择器 */
        .role-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            -webkit-overflow-scrolling: touch;
        }

        .role-chip {
            padding: 0.5rem 1rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .role-chip.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 续写按钮 */
        .continue-button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: var(--primary-color);
            background-color: transparent;
            border: 1px solid var(--primary-color);
            border-radius: 0.25rem;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.2s;
        }

        .continue-button:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* 工具提示 */
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 1000;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>AI 智能助手</h1>
            <div class="header-buttons">
                <button onclick="exportChat()">
                    <i class="fas fa-download"></i> 导出对话
                </button>
                <button onclick="clearChat()">
                    <i class="fas fa-trash"></i> 清空对话
                </button>
            </div>
        </header>

        <div class="role-selector">
            <div class="role-chip active" data-role="default">
                <i class="fas fa-robot"></i> 通用助手
            </div>
            <div class="role-chip" data-role="academic">
                <i class="fas fa-graduation-cap"></i> 学术专家
            </div>
            <div class="role-chip" data-role="programmer">
                <i class="fas fa-code"></i> 编程导师
            </div>
            <div class="role-chip" data-role="writer">
                <i class="fas fa-pen-fancy"></i> 文学创作
            </div>
            <div class="role-chip" data-role="translator">
                <i class="fas fa-language"></i> 翻译助手
            </div>
            <div class="role-chip" data-role="business">
                <i class="fas fa-chart-line"></i> 商业顾问
            </div>
        </div>

        <div id="chat-container"></div>
        <div id="suggestions"></div>
        <div class="error-message" id="error-message"></div>
        
        <div id="input-container">
            <textarea 
                id="user-input" 
                placeholder="请输入您的问题...（Shift + Enter 换行，Enter 发送）" 
                rows="1" 
                onkeydown="handleKeyPress(event)"
            ></textarea>
            <button id="send-button" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i> 发送
            </button>
            <button id="stop-button" onclick="stopGeneration()">
                <i class="fas fa-stop"></i> 停止
            </button>
        </div>
    </div>

    <script>
        const API_URL = 'http://221.224.253.54:60085/v1/chat/completions';
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        let messageHistory = [];
        let controller = null;
        let generating = false;

        // 默认配置
        const settings = {
            temperature: 0.7,
            maxTokens: 2000,
            maxHistory: 10
        };

        // 推荐问题列表
        const suggestedQuestions = [
            "你能帮我做什么？",
            "如何使用AI提高工作效率？",
            "讲个有趣的故事",
            "写一首诗",
            "解释一个复杂的概念",
            "给我一些学习建议"
        ];

        // 从localStorage加载历史记录
        function loadHistory() {
            const savedHistory = localStorage.getItem('chatHistory');
            if (savedHistory) {
                messageHistory = JSON.parse(savedHistory);
                messageHistory.forEach(msg => {
                    appendMessage(msg.role, msg.content, false);
                });
            }
        }

        // 保存历史记录到localStorage
        function saveHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(messageHistory));
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
            // 自动调整文本框高度
            autoResizeTextarea(event.target);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // 添加 Font Awesome 图标支持
        const fontAwesome = document.createElement('link');
        fontAwesome.rel = 'stylesheet';
        fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
        document.head.appendChild(fontAwesome);

        // 初始化推荐问题
        function initSuggestions() {
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';
            suggestedQuestions.forEach(question => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = question;
                chip.onclick = () => {
                    userInput.value = question;
                    sendMessage();
                };
                suggestionsDiv.appendChild(chip);
            });
        }

        // 停止生成
        function stopGeneration() {
            if (controller) {
                controller.abort();
                controller = null;
                generating = false;
                document.getElementById('stop-button').style.display = 'none';
                document.getElementById('send-button').style.display = 'inline-block';
            }
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 导出对话
        function exportChat() {
            const chatContent = messageHistory.map(msg => 
                `${msg.role === 'user' ? '我' : 'AI'}：${msg.content}`
            ).join('\n\n');
            
            const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `对话记录_${new Date().toLocaleString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 角色定义
        const roles = {
            default: {
                name: '通用助手',
                prompt: '你是一个智能AI助手，可以回答各种问题。'
            },
            academic: {
                name: '学术专家',
                prompt: '你是一个学术领域的专家，擅长解释复杂的学术概念，提供研究方法指导。请用专业且严谨的方式回答问题。'
            },
            programmer: {
                name: '编程导师',
                prompt: '你是一个编程专家，擅长解释编程概念，提供代码示例和最佳实践。请用清晰的方式回答技术问题。'
            },
            writer: {
                name: '文学创作',
                prompt: '你是一个文学创作者，擅长写作、润色和文学分析。请用优美的语言帮助用户。'
            },
            translator: {
                name: '翻译助手',
                prompt: '你是一个专业的翻译助手，精通多种语言，可以提供准确的翻译和语言学习建议。'
            },
            business: {
                name: '商业顾问',
                prompt: '你是一个商业顾问，擅长提供商业策略、市场分析和管理建议。请用专业的商业视角回答问题。'
            }
        };

        let currentRole = 'default';

        // 初始化上下文菜单
        function initContextMenu() {
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.display = 'none';
            document.body.appendChild(menu);

            // 监听选中文本事件
            document.addEventListener('mouseup', handleTextSelection);
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target)) {
                    menu.style.display = 'none';
                }
            });
        }

        // 处理文本选中
        function handleTextSelection(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText) {
                const menu = document.querySelector('.context-menu');
                menu.innerHTML = `
                    <div class="context-menu-item" onclick="explainText('${selectedText}', 'explain')">
                        <i class="fas fa-book"></i> 专业解释
                    </div>
                    <div class="context-menu-item" onclick="explainText('${selectedText}', 'translate')">
                        <i class="fas fa-language"></i> 翻译
                    </div>
                    <div class="context-menu-item" onclick="explainText('${selectedText}', 'example')">
                        <i class="fas fa-lightbulb"></i> 举例说明
                    </div>
                `;
                
                const rect = selection.getRangeAt(0).getBoundingClientRect();
                menu.style.top = `${window.scrollY + rect.bottom + 10}px`;
                menu.style.left = `${window.scrollX + rect.left}px`;
                menu.style.display = 'block';
            }
        }

        // 解释选中的文本
        async function explainText(text, type) {
            document.querySelector('.context-menu').style.display = 'none';
            let prompt = '';
            switch (type) {
                case 'explain':
                    prompt = `请专业地解释"${text}"这个概念或词语，包括其定义、用法和相关知识。`;
                    break;
                case 'translate':
                    prompt = `请将"${text}"翻译成中英文对照，并解释其用法。`;
                    break;
                case 'example':
                    prompt = `请举例说明"${text}"的具体应用场景和使用方法。`;
                    break;
            }
            userInput.value = prompt;
            await sendMessage();
        }

        // 初始化角色选择器
        function initRoleSelector() {
            const roleChips = document.querySelectorAll('.role-chip');
            roleChips.forEach(chip => {
                chip.addEventListener('click', () => {
                    roleChips.forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentRole = chip.dataset.role;
                    // 添加角色切换提示
                    appendMessage('system', `已切换到${roles[currentRole].name}模式。`);
                });
            });
        }

        // 修改发送消息函数，添加角色提示
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || generating) return;

            generating = true;
            document.getElementById('stop-button').style.display = 'inline-block';
            document.getElementById('send-button').style.display = 'none';

            userInput.disabled = true;
            controller = new AbortController();

            appendMessage('user', message);
            messageHistory.push({ role: 'user', content: message });
            userInput.value = '';
            autoResizeTextarea(userInput);

            const rolePrompt = roles[currentRole].prompt;
            messageHistory.push({ role: 'system', content: rolePrompt });

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: './chatglm3-6b-new',
                        messages: messageHistory,
                        stream: true,
                        temperature: settings.temperature,
                        max_tokens: settings.maxTokens
                    }),
                    signal: controller.signal
                });

                // 创建一个新的消息div用于流式显示
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot-message animate';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                messageDiv.appendChild(contentDiv);
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                let fullResponse = '';
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices[0].delta.content || '';
                                fullResponse += content;
                                
                                // 使用marked处理已收到的全部内容
                                contentDiv.innerHTML = marked.parse(fullResponse);
                                
                                // 代码高亮
                                contentDiv.querySelectorAll('pre code').forEach((block) => {
                                    hljs.highlightBlock(block);
                                });
                                
                                chatContainer.scrollTop = chatContainer.scrollHeight;
                            } catch (e) {
                                console.error('解析响应出错:', e);
                            }
                        }
                    }
                }

                // 添加复制按钮
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'message-actions';
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = '复制';
                copyButton.onclick = () => copyMessage(fullResponse);
                actionsDiv.appendChild(copyButton);
                messageDiv.appendChild(actionsDiv);

                // 保存到历史记录
                messageHistory.push({ role: 'assistant', content: fullResponse });
                saveHistory();
            } catch (error) {
                if (error.name === 'AbortError') {
                    appendMessage('bot', '已停止生成');
                } else {
                    console.error('Error:', error);
                    showError('发生错误，请稍后重试');
                }
            } finally {
                generating = false;
                controller = null;
                document.getElementById('stop-button').style.display = 'none';
                document.getElementById('send-button').style.display = 'inline-block';
                userInput.disabled = false;
                userInput.focus();
            }
        }

        function appendMessage(role, content, shouldAnimate = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message${shouldAnimate ? ' animate' : ''}`;

            // 创建消息内容容器
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = marked.parse(content);

            // 添加复制按钮
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.textContent = '复制';
            copyButton.onclick = () => copyMessage(content);
            actionsDiv.appendChild(copyButton);

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(actionsDiv);
            chatContainer.appendChild(messageDiv);

            // 代码高亮
            messageDiv.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });

            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (role === 'bot') {
                const continueButton = document.createElement('button');
                continueButton.className = 'continue-button';
                continueButton.innerHTML = '<i class="fas fa-pencil-alt"></i> 继续生成';
                continueButton.onclick = () => continueGeneration(content);
                messageDiv.appendChild(continueButton);
            }
        }

        function copyMessage(content) {
            navigator.clipboard.writeText(content).then(() => {
                alert('已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }

        function clearChat() {
            if (confirm('确定要清空所有对话记录吗？')) {
                chatContainer.innerHTML = '';
                messageHistory = [];
                localStorage.removeItem('chatHistory');
            }
        }

        // 续写生成
        async function continueGeneration(previousContent) {
            const prompt = `请继续上文的内容：\n${previousContent}`;
            userInput.value = prompt;
            await sendMessage();
        }

        // 页面加载时初始化所有功能
        window.onload = function() {
            loadHistory();
            initSuggestions();
            initContextMenu();
            initRoleSelector();
        };
    </script>
</body>
</html>